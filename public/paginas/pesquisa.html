<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,300;1,300&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../estilos/pesquisa.css">
    <title>LocalTop</title>
</head>

<body style="background-color: #F7EFE6; display: flex; flex-direction: column;">
    <header style="display: flex; align-items: center;">
  <a href="/" class="logoLink">
    <img src="../imagens/logo/SVG Variações/Branco/Horizontal-Branco-changed.svg" alt="Logo LocalTop" class="logo">
  </a>
  <nav class="servicos" >
    <a href="pesquisa" class="encontrar">Encontrar <p>LocalTop</p></a>
    <a href="/perfil">Divulgar Serviço</a>
    <a href="/#sobre">Sobre Nós</a>
  </nav>
  <nav class="infos" id="infos">
    <a href="/login" class="logar">Login</a><a href="/signup" class="cadastrar">Cadastrar-se</a>
  </nav>
</header>
    <br>
    <div class="container-fluid" style="display: flex; justify-content: center;">
        <img src="../imagens/bannerpesquisa.webp" style="height: 100%; width: 100%;">
    </div>
    <br>
    <br>
    <div style="border: 2px solid re; display: flex; margin-left: 2dvi;">
        <div style="border: 2px solid blu;">
            <h3 style="color: #302163;"> FILTRO DE OPÇÕES </h3>
            <hr>
            <h4 style="color: #3BA06D;"> CATEGORIAS </h4>
            <input type="checkbox" name="categoria" value="1"> BELEZA & BEM ESTAR
            <br>
            <input type="checkbox" name="categoria" value="2"> PET
            <br>
            <input type="checkbox" name="categoria" value="3"> RESIDENCIAL
            <br>
            <input type="checkbox" name="categoria" value="4"> LIMPEZA
            <br>
            <input type="checkbox" name="categoria" value="5"> TECNOLOGIA
            <hr>
            <H4 style="color: #3BA06D;"> PREÇO </H4>
            <h4> R$ 0 - R$ 10000 </h4>
            <input type="range">
            <hr>
            <h4 style="color: #3BA06D;"> CIDADE </h4>
            <input list="cidades" id="cidades-choice" name="cidades-choice"
                style=" width: 10dvi; height: 1.2dvi; border-radius: 1dvi; border: 2px solid #3BA06D;">

            <datalist id="cidades">
                <option value="Araucaria"></option>
                <option value="Curitiba"></option>
                <option value="Dois Vizinhos"></option>
                <option value="Ponta Grossa"></option>
                <option value="Londrina"></option>
            </datalist>
            <hr>
            <h4 style="color: #3BA06D;"> AVALIAÇÃO </h4>
            <input type="radio" name="avaliacao" value="5"> 5 ⭐
            <br>
            <input type="radio" name="avaliacao" value="4"> 4 ⭐
            <br>
            <input type="radio" name="avaliacao" value="3"> 3 ⭐
            <br>
            <input type="radio" name="avaliacao" value="2"> 2 ⭐
            <br>
            <input type="radio" name="avaliacao" value="1"> 1 ⭐
        </div>
        <div style="width: 1px; height: 100%dvi; background-color: black; margin-left: 2dvi;">
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; padding-left: 30px; ;"
            class="container-fluid">
            <div style="padding-bottom: 2dvi; ; display: flex; justify-content: space-between; width: 90%;">
                <div>
                    <button id="btnAplicarFiltros" style="border-radius: 20px;" onclick="listarEstabelecimentosComFiltros"> Aplicar filtros </button>
                    <button id="btnLimparFiltros" style="border-radius: 20px;"> Limpar filtros </button>
                </div>
                <input type="search" id="inputSearch" placeholder="Procurando por um estabelecimento especifico?"
                    style="border-radius: 20px; width: 25dvi; height: 1.6dvi; padding-left: 10px;">

                <select name="ordem" id="ordem-choice" name="ordem-choice"
                    style="border-radius: 20px; width: 7dvi; height: 1.6dvi; padding-left: 10px; color: black;">
                    <option value="Ordem"> Ordem</option>
                    <option value="↓ Preço">↓ Preço</option>
                    <option value="↑ Preço">↑ Preço</option>
                    <option value="↓ Avaliação">↓ Avaliação</option>
                    <option value="↑ Avaliação">↑ Avaliação</option>
                </select>

            </div>
            <div class="grade-produtos" id="grade-produtos">

            </div>
        </div>
    </div>

    </div>
    <script>
        let podeVerificar = true;

    // Verifica o estado de login e, se estiver logado, ativa o monitoramento de sessão
    const inicializarVerificacaoDeSessao = async () => {
      try {
        const infos = document.getElementById("infos");
        const resposta = await fetch("/auth/estado");
        const dados = await resposta.json();
        if (!dados.logado) {
          infos.innerHTML = `<a href="/login" class="logar">Login</a><a href="/signup" class="cadastrar">Cadastrar-se</a>`
        }
        if (dados.logado) {
          if (dados.adm) {
            infos.innerHTML = `<h3 id="nomeUsu">Nome Usuário </h3>
            <div class="usuario">
              <button class="dropdownUsuario" id="BtnDropdown" onclick="dropdown()">
                <img src="../imagens/SVGs/perfil.svg" alt="Minha Conta" class="conta">
              </button>
              <div class="dropdown-content">
                <a href="/perfil">Meu Perfil</a>
                <a href="/listaUsuarios">Usuários</a>
                <a href="/listaLojas">Estabelecimentos</a>
                <button id="logoutBtn" onclick="logout()">Sair</button>
              </div>
            </div>`
          } else {
            infos.innerHTML = `<h3 id="nomeUsu">Nome Usuário </h3>
            <div class="usuario">
              <button class="dropdownUsuario" id="BtnDropdown" onclick="dropdown()">
                <img src="../imagens/SVGs/perfil.svg" alt="Minha Conta" class="conta">
              </button>
              <div class="dropdown-content">
                <a href="/perfil">Meu Perfil</a>
                <button id="logoutBtn" onclick="logout()">Sair</button>
              </div>
            </div>`
          }
          ativarMonitoramento();
        }
      } catch (err) {
        console.error("Erro ao verificar login inicial:", err);
      }
    };
    const verificarSessao = async () => {
      if (!podeVerificar) return;
      podeVerificar = false;
      try {
        const resposta = await fetch("/auth/estado");
        const dados = await resposta.json();
        if (!dados.logado) {
          Swal.fire({
            icon: 'error',
            title: 'Sua sessão expirou',
            text: 'Aperte OK para ser redirecionado para a tela de login ou espere para ser redirecionado.',
            timer:5000,
            timerProgressBar: true
          }).then((result) => {
            sessionStorage.clear();
            if (result.isConfirmed) {
              window.location.href = "/login";
            }
            if (result.dismiss === Swal.DismissReason.timer) {
              window.location.href = "/login";
            }
          })
        }
      } catch (err) {
        console.error("Erro ao verificar sessão:", err);
      }
      setTimeout(() => {
        podeVerificar = true;
      }, 10000); // 10 segundos entre verificações
    };
    const ativarMonitoramento = () => {
      ['click', 'keydown', 'mousemove', 'scroll'].forEach(evento => {
        document.addEventListener(evento, verificarSessao);
      });
    };
    // Inicia tudo ao carregar a página
    inicializarVerificacaoDeSessao();
    async function logout() {
      try {
        const resposta = await fetch("/logout", {
          method: "GET",
        });
        if (resposta.ok) {
          // Quando o logout for bem-sucedido, redireciona para o login ou página inicial
          window.location.href = "/login";
        } else {
          alert("Erro ao fazer logout.");
        }
      } catch (err) {
        console.error("Erro ao fazer logout:", err);
      }
    }
    function dropdown() {
      const dropdown = document.querySelector(`.dropdown-content`);
      dropdown.style.display === "flex" ? dropdown.style.display = "none" : dropdown.style.display = "flex";
    }
    async function pegarDados() {
      try {
        const resposta = await fetch("/auth/estado");
        const dados = await resposta.json();
        const response = await fetch(`/api/usuario/${dados.usuarioId}`, {
          method: 'GET'
        })
        const usuario = await response.json();
        document.getElementById("nomeUsu").innerHTML = `Olá, ${usuario.Nome.split(" ")[0] }`;
        const responseImg = await fetch(`/api/usuario/${dados.usuarioId}/foto`,{
          method: 'GET'
        })
        if (responseImg.status === 202) {
          return;
        }
        else if (responseImg.ok) {
          if (responseImg.status === 204) {
           return;
          }
          // Tem imagem, exibe
          const img = await responseImg.blob();
          document.querySelector(".conta").src = URL.createObjectURL(img);
        } else {
          console.error(`Erro ao carregar imagem. Status: ${responseImg.status}`);
        }
      } catch (error) {
        console.log(`Erro ao requisitar os dados do banco.\n${error}`);
      }
    }

    document.addEventListener('DOMContentLoaded', pegarDados())
    </script>

    <script src="../scripts/pesquisa.js"></script>
</body>

</html>